# 7.1. Creación de Tablas

```sql
-- Eliminar tablas
--modu1

DROP TABLE IF EXISTS ordenes_entrega CASCADE;
DROP TABLE IF EXISTS Producto CASCADE;
DROP TABLE IF EXISTS Prioridad CASCADE;
DROP TABLE IF EXISTS Tipo_producto CASCADE;
DROP TABLE IF EXISTS Usuario CASCADE;
DROP TABLE IF EXISTS Permite CASCADE;
DROP TABLE IF EXISTS Contiene CASCADE;

--
DROP TABLE IF EXISTS evidencia CASCADE;
DROP TABLE IF EXISTS reclamo CASCADE;
DROP TABLE IF EXISTS Incidencia CASCADE;
DROP TABLE IF EXISTS Monitoreo_ruta CASCADE;
DROP TABLE IF EXISTS EventoEntrega CASCADE;
DROP TABLE IF EXISTS RecepcionOrdenes CASCADE;
DROP TABLE IF EXISTS Asignacion_transporte CASCADE;
DROP TABLE IF EXISTS calidad_vehiculo CASCADE;
DROP TABLE IF EXISTS Carga CASCADE;
DROP TABLE IF EXISTS Ruta CASCADE;
DROP TABLE IF EXISTS Conductor CASCADE;
DROP TABLE IF EXISTS Vehiculo CASCADE;
DROP TABLE IF EXISTS Cliente CASCADE;
DROP TABLE IF EXISTS GestionReclamos CASCADE;
DROP TABLE IF EXISTS usuario CASCADE;
DROP TABLE IF EXISTS plan_entrega CASCADE;
DROP TABLE IF EXISTS ruta_plan CASCADE;
DROP TABLE IF EXISTS direccion_plan CASCADE;

-- Eliminar tipos si existen
DROP TYPE IF EXISTS estado_vehiculo CASCADE;
DROP TYPE IF EXISTS estado_conductor CASCADE;
DROP TYPE IF EXISTS tipo_vehiculo CASCADE;
DROP TYPE IF EXISTS tipo_licencia CASCADE;
DROP TYPE IF EXISTS genero CASCADE;
DROP TYPE IF EXISTS tipo_cliente CASCADE;
DROP TYPE IF EXISTS tipo_negocio CASCADE;
DROP TYPE IF EXISTS estado_ruta CASCADE;
DROP TYPE IF EXISTS tipo_incidencia CASCADE;
DROP TYPE IF EXISTS severidad_incidencia CASCADE;
DROP TYPE IF EXISTS estado_gps CASCADE;
DROP TYPE IF EXISTS estado_carga CASCADE;
DROP TYPE IF EXISTS canal_de_atencion CASCADE;
DROP TYPE IF EXISTS hub CASCADE;
DROP TYPE IF EXISTS tipo_producto CASCADE;
DROP TYPE IF EXISTS sku CASCADE;
DROP TYPE IF EXISTS estado_reclamo_enum CASCADE;
DROP TYPE IF EXISTS tipo_reclamo_enum CASCADE;
DROP TYPE IF EXISTS tipo_evidencia_enum CASCADE;
DROP TYPE IF EXISTS tipo_archivo_enum CASCADE;
DROP TYPE IF EXISTS estado_plan CASCADE;

--Creacion de types
CREATE TYPE estado_vehiculo AS ENUM ('activo', 'inactivo');
CREATE TYPE estado_conductor AS ENUM ('activo', 'inactivo');
CREATE TYPE tipo_vehiculo AS ENUM ('camion', 'camioneta', 'furgoneta');
CREATE TYPE tipo_licencia AS ENUM ('A', 'B', 'C');
CREATE TYPE genero AS ENUM ('M', 'F', 'O');
CREATE TYPE tipo_cliente AS ENUM ('empresa', 'persona_natural');
CREATE TYPE tipo_negocio AS ENUM ('restaurante', 'hotel', 'supermercado', 'distribuidor', 'otro');
CREATE TYPE estado_ruta AS ENUM ('activo', 'inactivo');
CREATE TYPE tipo_incidencia AS ENUM (
    'accidente', 
    'averia_vehiculo', 
    'desvio_ruta', 
    'problema_temperatura', 
    'retraso', 
    'clima_adverso',
    'problema_trafico',
    'apertura_no_autorizada',
    'otro'
);
CREATE TYPE severidad_incidencia AS ENUM ('baja', 'media', 'alta', 'critica');
CREATE TYPE estado_gps AS ENUM ('activo', 'inactivo', 'mantenimiento');
CREATE TYPE canal_de_atencion AS ENUM ('autoservicio', 'foodservice', 'instituciones');
CREATE TYPE hub AS ENUM ('Esmeralda', 'Independencia', 'Huaral', 'Chincha');
CREATE TYPE tipo_producto AS ENUM ('pollo', 'pavo', 'embutido', 'cerdo', 'huevo');
CREATE TYPE estado_reclamo_enum AS ENUM (
    'solucionado', 
    'en pausa', 
    'en proceso',
    'rechazado'
);
CREATE TYPE tipo_reclamo_enum AS ENUM (
    'producto mal estado', 
    'producto equivocado', 
    'pedido incompleto',
    'no llegó el producto'  
);
CREATE TYPE tipo_evidencia_enum AS ENUM (
    'I',  -- Imagen
    'V',  -- Video
    'A',  -- Audio
    'D'   -- Documento
);
CREATE TYPE tipo_archivo_enum AS ENUM (
    'jpg',
    'png',
    'pdf',
    'mp4',
    'mp3'
);
CREATE TYPE estado_plan AS ENUM ('pendiente', 'validado');
CREATE TYPE nivel_prioridad AS ENUM (
    'baja',      -- Para entregas no urgentes
    'media',     -- Para entregas normales
    'alta',      -- Para entregas urgentes
    'critica'    -- Para entregas de máxima urgencia
);
CREATE TYPE tipo_conservacion AS ENUM ('refrigerado', 'congelado', 'seco');

-- Creación de las tablas

-- Tablas ya existentes
CREATE TABLE Cliente (
    id_cliente UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    tipo_cliente tipo_cliente NOT NULL,
    RUC VARCHAR(11) CHECK (RUC ~ '^[0-9]{11}$'),
    DNI CHAR(8) CHECK (DNI ~ '^[0-9]{8}$'),
    direccion VARCHAR(200) NOT NULL,
    distrito VARCHAR(50) NOT NULL,
    provincia VARCHAR(50) NOT NULL,
    departamento VARCHAR(50) NOT NULL,
    telefono VARCHAR(20) NOT NULL,
    telefono_alternativo VARCHAR(20),
    email VARCHAR(100),
    tipo_negocio tipo_negocio,
    horario_atencion VARCHAR(100),
    fecha_registro TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Vehiculo (
    id_vehiculo UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    placa VARCHAR(20) NOT NULL UNIQUE CHECK (placa ~ '^[A-Z]{3}-[0-9]{3}$'),
    marca VARCHAR(50) NOT NULL,
    modelo VARCHAR(50) NOT NULL,
    año INTEGER NOT NULL CHECK (año BETWEEN 2000 AND EXTRACT(YEAR FROM CURRENT_DATE)),
    color VARCHAR(30) NOT NULL,
    tipo_vehiculo tipo_vehiculo NOT NULL,
    capacidad_carga DECIMAL(10,2) NOT NULL CHECK (capacidad_carga > 0),
    capacidad_combustible DECIMAL(10,2) NOT NULL CHECK (capacidad_combustible > 0),
    estado_vehiculo estado_vehiculo DEFAULT 'activo',
    numero_soat VARCHAR(20) NOT NULL UNIQUE CHECK (numero_soat ~ '^[A-Z]{3}-[0-9]{3}$'),
    fecha_vencimiento_soat DATE NOT NULL,
    fecha_registro TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    gps_imei VARCHAR(50) NOT NULL UNIQUE,
    gps_estado estado_gps NOT NULL DEFAULT 'activo',
    foto_vehiculo VARCHAR(255)
);

CREATE TABLE Conductor (
    id_conductor UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    DNI CHAR(8) NOT NULL UNIQUE CHECK (DNI ~ '^[0-9]{8}$'),
    nombre_conductor VARCHAR(100) NOT NULL,
    telefono_conductor VARCHAR(9) NOT NULL,
    email_conductor VARCHAR(100) NOT NULL,
    direccion_conductor TEXT,
    licencia_conductor VARCHAR(20) NOT NULL,
    estado_conductor estado_conductor DEFAULT 'activo',
    tipo_licencia tipo_licencia NOT NULL,
    fecha_emision_licencia DATE NOT NULL,
    fecha_vencimiento_licencia DATE NOT NULL,
    fecha_nacimiento DATE NOT NULL,
    fecha_registro TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    genero genero NOT NULL,
    foto_conductor VARCHAR(255)
);

-- modulo 1

CREATE TABLE Usuario (
    id_usuario UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre_usuario VARCHAR(255) NOT NULL,
    rol VARCHAR(100) NOT NULL,
    contrasena VARCHAR(255) NOT NULL,
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- revision
CREATE TABLE Recepcion_solicitud (
    id_orden UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    codigo_orden VARCHAR(20) NOT NULL UNIQUE,
    tipo_orden VARCHAR(10) CHECK (tipo_orden IN ('AVICOLA', 'CONSUMO', 'MIXTA')),
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    prioridad SMALLINT CHECK (prioridad BETWEEN 1 AND 5),
    cliente_id UUID NOT NULL REFERENCES Cliente(id_cliente)
);


CREATE TABLE Orden_entrega (
    id_orden_entrega UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    destino VARCHAR(100) NOT NULL,
    id_usuario UUID NOT NULL REFERENCES Usuario(id_usuario),
    coordenada_destino POINT NOT NULL,
    fecha_orden TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    descripcion TEXT NOT NULL,
    id_cliente UUID NOT NULL REFERENCES Cliente(id_cliente),
    nivel_prioridad nivel_prioridad NOT NULL,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Producto (
    id_producto UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre_producto VARCHAR(255) NOT NULL,
    peso_total DECIMAL(10, 2) NOT NULL CHECK (peso_total > 0),
    volumen_total DECIMAL(10, 2) NOT NULL CHECK (volumen_total > 0),
    tipo_producto tipo_producto NOT NULL,
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Detalle_Orden (
    id_detalle_orden UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_producto UUID NOT NULL REFERENCES Producto(id_producto),
    id_orden_entrega UUID NOT NULL REFERENCES Orden_entrega(id_orden_entrega),
    cantidad INT NOT NULL CHECK (cantidad > 0),
    precio_unitario DECIMAL(10,2) NOT NULL, 
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(id_producto, id_orden_entrega)
);

-- modulo 2

CREATE TABLE Carga (
    id_carga UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_usuario UUID NOT NULL REFERENCES Usuario(id_usuario),
    tipo_conservacion tipo_conservacion NOT NULL, -- ENUM: 'refrigerado', 'congelado', 'seco'
    rango_inicial_temperatura_requerida DECIMAL(4,2), -- Para productos refrigerados/congelados
    rango_final_temperatura_requerida DECIMAL(4,2), -- Para productos refrigerados/congelados
    ubicacion_origen hub NOT NULL, -- ENUM: 'Esmeralda', 'Independencia', 'Huacho', 'Pucusana'
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    observaciones TEXT
);

CREATE TABLE Detalle_carga (
    id_detalle_carga UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_carga UUID NOT NULL REFERENCES Carga(id_carga) ON DELETE CASCADE,
    id_detalle_orden UUID NOT NULL REFERENCES Detalle_Orden(id_detalle_orden) ON DELETE CASCADE,
    peso DECIMAL(10,2) NOT NULL CHECK (peso > 0),
    observaciones TEXT,
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(id_carga, id_detalle_orden)
);

CREATE TABLE Punto_entrega (
    id_punto_entrega UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre_punto VARCHAR(100) NOT NULL,
    tipo_punto VARCHAR(20) CHECK (tipo_punto IN ('terminal', 'cliente')),
    coordenada_punto POINT NOT NULL,
    zona VARCHAR(100) NOT NULL,
    horario_atencion VARCHAR(100) NOT NULL,
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Tramo_ruta (
    id_tramo_ruta UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_origen UUID NOT NULL REFERENCES Punto_entrega(id_punto_entrega),
    id_destino UUID NOT NULL REFERENCES Punto_entrega(id_punto_entrega),
    nombre_ruta VARCHAR(100) NOT NULL,
    recorrido_km DECIMAL(10,2) NOT NULL CHECK (recorrido_km > 0),
    distancia_km DECIMAL(10,2) NOT NULL CHECK (distancia_km > 0),
    tiempo_estimado INTERVAL NOT NULL,
    ruta_planificada POINT[] NOT NULL, -- conjunto de puntos
    estado_ruta VARCHAR(20) DEFAULT 'activo' CHECK (estado_ruta IN ('activo', 'inactivo')),
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_distancias CHECK (recorrido_km >= distancia_km),
    CONSTRAINT check_origen_destino CHECK (id_origen != id_destino)
);

CREATE TABLE Plan_entrega (
    id_plan_entrega UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    tiempo_total_estimado INTERVAL NOT NULL,
    recorrido_total_km DECIMAL(10,2) NOT NULL CHECK (recorrido_total_km > 0),
    distancia_total_km DECIMAL(10,2) NOT NULL CHECK (distancia_total_km > 0),
    id_usuario UUID NOT NULL REFERENCES Usuario(id_usuario),
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Detalle_plan_entrega (
    id_detalle_plan_entrega UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_plan_entrega UUID NOT NULL REFERENCES Plan_entrega(id_plan_entrega),
    id_tramo_ruta UUID NOT NULL REFERENCES Tramo_ruta(id_tramo_ruta),
    id_detalle_carga UUID NOT NULL REFERENCES Detalle_carga(id_detalle_carga),
    orden_parada NUMERIC(2) NOT NULL CHECK (orden_parada > 0),
    tiempo_estimado_parada INTERVAL NOT NULL,
    tiempo_descarga_estimado INTERVAL NOT NULL,
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(id_plan_entrega, orden_parada)
);

-- modulo 3

-- Veihulo y Conductor (encargado de crear, modificar y eliminar) tambien pertenecen a este modulo

CREATE TABLE Asignacion_transporte (
    id_asignacion_transporte UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_vehiculo UUID NOT NULL REFERENCES Vehiculo(id_vehiculo),
    id_conductor UUID NOT NULL REFERENCES Conductor(id_conductor),
    id_plan_entrega UUID NOT NULL REFERENCES Plan_entrega(id_plan_entrega),
    id_usuario UUID NOT NULL REFERENCES Usuario(id_usuario),
    estado_asignacion VARCHAR(20) DEFAULT 'pendiente' CHECK (estado_asignacion IN ('pendiente', 'en_proceso', 'completada', 'cancelada')),
    fecha_inicio_estimada TIMESTAMPTZ,
    fecha_fin_estimada TIMESTAMPTZ,
    observaciones TEXT,
    fecha_creacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_fechas CHECK (fecha_inicio_estimada < fecha_fin_estimada)
);

-- modulo 4

CREATE TABLE Condicion_despacho (
    id_condicion_despacho UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre_condicion VARCHAR(100) NOT NULL,
    descripcion TEXT
);

CREATE TABLE Resultado_condicion_despacho (
    id_resultado_condicion_despacho UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_asignacion_transporte UUID NOT NULL REFERENCES Asignacion_transporte(id_asignacion_transporte) ON DELETE CASCADE,
    id_condicion_despacho UUID NOT NULL REFERENCES Condicion_despacho(id_condicion_despacho),
    resultado BOOLEAN NOT NULL, -- TRUE si está apto, FALSE si no
    observaciones TEXT,
    id_usuario UUID NOT NULL REFERENCES Usuario(id_usuario),
    fecha_verificacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id_asignacion_transporte, id_condicion)
);

CREATE TABLE Despacho (
    id_despacho UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_asignacion_transporte UUID NOT NULL UNIQUE REFERENCES Asignacion_transporte(id_asignacion_transporte),
    fecha_despacho TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    estado_recorrido VARCHAR(20) DEFAULT 'en_ruta' CHECK (estado_asignacion IN ('en_ruta', 'completada', 'cancelada')),
    fecha_actualizacion TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    id_usuario UUID NOT NULL REFERENCES Usuario(id_usuario),
    observaciones TEXT
);

-- modulo 5
CREATE TABLE Monitoreo_ruta (
    id_monitoreo UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_asignacion UUID NOT NULL REFERENCES Asignacion_transporte(id_asignacion_transporte),
    ubicacion_actual POINT NOT NULL,
    velocidad DECIMAL(5,2) NOT NULL CHECK (velocidad >= 0),
    temperatura_carga DECIMAL(5,2),
    combustible_restante DECIMAL(5,2) CHECK (combustible_restante >= 0),
    estado_compartimento VARCHAR(20) CHECK (estado_compartimento IN ('cerrado', 'abierto')),
    timestamp_registro TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    distancia_recorrida DECIMAL(10,2) NOT NULL DEFAULT 0,
    tiempo_transcurrido INTERVAL NOT NULL DEFAULT '00:00:00'
);

CREATE TABLE Incidencia (
    id_incidencia UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_monitoreo UUID NOT NULL REFERENCES Monitoreo_ruta(id_monitoreo),
    tipo_incidencia tipo_incidencia NOT NULL,
    severidad severidad_incidencia NOT NULL,
    descripcion TEXT NOT NULL,
    estado VARCHAR(20) NOT NULL DEFAULT 'pendiente' CHECK (estado IN ('pendiente', 'en_proceso', 'resuelta')),
    fecha_registro TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    fecha_resolucion TIMESTAMPTZ,
    acciones_tomadas TEXT,
    observaciones TEXT
);

-- modulo 6

-- revision
CREATE TABLE Entrega (
    id_entrega UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_orden_entrega UUID NOT NULL REFERENCES Orden_entrega(id_orden_entrega),
    id_conductor UUID NOT NULL REFERENCES Conductor(id_conductor),
    fecha_entrega TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    estado_entrega VARCHAR(20) NOT NULL CHECK (estado_entrega IN (
        'completada', 
        'fallida', 
        'con_reclamo',
        'reprogramada'
    )),
    firma_cliente VARCHAR(255),
    evidencia VARCHAR(255),
    observaciones VARCHAR(200)
);

-- modulo 7

CREATE TABLE Reclamo (
    id_reclamo UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_entrega UUID NOT NULL REFERENCES Entrega(id_entrega),
    id_cliente UUID NOT NULL REFERENCES Cliente(id_cliente),
    descripcion TEXT,
    fecha_reclamo TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    estado estado_reclamo_enum NOT NULL,
    tipo_reclamo tipo_reclamo_enum NOT NULL
);

CREATE TABLE Evidencia (
    id_evidencia UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    id_reclamo UUID NOT NULL REFERENCES reclamo(id_reclamo),
    tipo_evidencia tipo_evidencia_enum NOT NULL,
    tipo_archivo tipo_archivo_enum NOT NULL,
    nombre_evidencia VARCHAR(60) DEFAULT NULL,
    url_archivo TEXT DEFAULT NULL
);

```
