# 8.1. Búsqueda de texto


## Aplicación de índices invertidos: Primer Escenario

En el caso de que un auditor por medio de sus roles atribuidos como usuario específico, desee indagar sobre los eventos de entrega para encontrar casos en los que el tráfico, calidad del producto, o la dirección sean variables protagónicas. El auditor puede considerar analizar todos los eventos de entrega en los que la palabra "tráfico" esté involucrado, y para ello va a servirse del atributo 'observaciones' junto con el uso de índices invertidos, para obtener los id's de entregas de su interés y posterior estudio.

Antes de dar con las líneas SQL que conducen a la solución, vamos a explicar en qué se basa la lógica de los índices invertidos, y su implementación en entornos como el de PostgreSQL.

### Indice invertido
Es análogo al índice de un libro, pero invertido.
- En un libro: Palabra → Páginas donde aparece
- En la BD: Token → IDs de registros que lo contienen

### Tokenización
Usualmente se procede a 'normalizar' la palabra sobre la cual va a trabajarse el índice invertido. Este proceso consta de:
- Convertir a minúsculas: "Tráfico" → "tráfico"
- Eliminar acentos (opcional): "tráfico" → "trafico"
- Remover stopwords: "el trafico" → "trafico"

También se aplica Stemming (obtención de raíz léxica):
- "corriendo" → "corr"
- "direcciones" → "direccion"

El resultado es un vector de tokens, donde 'posiciones' representa la posición de la palabra en el texto original.

Por ejemplo, para los textos siguientes almacenados en 'observaciones':
- 'La **dirección** *incorrecta*'
- 'Demora por **tráfico** en la zona'

Se almacenan en el vector de tokens como:

```typescript
{
  "tokens": [
    {
      "lexema": "direccion",
      "posiciones": [2],
      "pesos": null
    },
    {
      "lexema": "incorrect",
      "posiciones": [3],
      "pesos": null
    }
    {
      "lexema": "trafic",
      "posiciones": [3],
      "pesos": null
    }
  ]
}
```

### Estructura del índice
Se le llama Generalized Inverted Index (GIN), y este almacena:

| Token (lexema) | TIDs (Tuple IDs)          |
|----------------|---------------------------|
| "direccion"    | (1,2), (1,5), (3,1)       |
| "trafic"    | (1,3), (3,2)              |
| "product"      | (1,4), (2,1)              |

Donde (1,2) significa:

- 1: número del bloque
- 2: posición dentro del bloque

*Nota: Por bloque nos referimos al bloque físico del disco (8KB para PostgreSQL), donde tenemos almacenados nuestros registros.*

### Relación con la base de datos 

En nuestra tabla Entrega (es opcional el TID físico como columna adicional) si tenemos:

| id_entrega (UUID)   | observaciones (texto)       | TID físico |
|---------------------|----------------------------|------------|
| 1ac4efb0-...       | "Dirección incorrecta"     | (5,2)      |
| 6b0014d8-...       | "Entrega exitosa"          | (7,1)      |
| 09fd74b5-...       | "Demora por tráfico en la zona" | (2,7)      |

Entonces nuestro índice invertido almacenará:

| Token       | TIDs   |
|:-----------:|:------:|
| "direccion" | (5,2)  |
| "incorrect" | (5,2)  |
| "entrega"   | (7,1)  |
| "exitos"    | (7,1)  |
| "trafic"    | (2,7)  |

### Ejecución de búsqueda

1. Crea el índice tokenizando valores de 'observaciones':
```sql
   CREATE INDEX idx_observaciones_gin ON Entrega
   USING gin(to_tsvector('spanish', observaciones));
```

2. Seleccionar tabla, vector de tokens y realizar la consulta:

*Nota: 1. Aquí no se referencia directamente al índice GIN, ya que PostgreSQL lo maneja automáticamente dado que está asociado con to_tsvector.*

*Nota 2. Al aplicar **to_tsquery('spanish', 'tráfico')** se obtiene **'trafic' (stemming)***

```sql
   SELECT * FROM Entrega 
   WHERE to_tsvector('spanish', observaciones) @@ to_tsquery('spanish', 'trafico');
```
3. Obtendremos todos los id's de entrega involucrados con el asunto de 'tráfico' en el campo *observaciones* que el conductor registró en su momento, utilizando índices invertidos.

Ejecución de la consulta en SupaBase:
![Ejecución](indiceinv.png)

Visualización de los TIDs donde se referencia la localización física de los registros:
![Ejecución](ctid.png)


